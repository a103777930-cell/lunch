<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>åˆé¥­æ’ç­</title>
<style>
  body { font-family: Arial; padding: 20px; }
  h2 { margin-top: 25px; }
  .user { margin: 5px 0; }
  button { margin-left: 6px; }
  .full { color: red; }
  table { border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
</style>
</head>

<body>

<h1>ğŸ± åˆé¥­æ’ç­</h1>

<!-- å½“å‰ç”¨æˆ· -->
<div id="currentUserBar" style="display:none;margin-bottom:10px;">
  å½“å‰ç”¨æˆ·ï¼š<b id="currentUserName"></b>
  <button onclick="logout()">åˆ‡æ¢</button>
</div>

<!-- ç™»å½• -->
<div id="loginBox">
  ğŸ‘¤ æˆ‘æ˜¯ï¼š
  <select id="userSelect"></select>
  <button onclick="login()">ç¡®è®¤</button>
</div>

<hr>

<!-- äººå‘˜ç®¡ç† -->
<h2>ğŸ‘¥ äººå‘˜è®¾ç½®</h2>
<input id="newUserInput" placeholder="æ–°å¢äººå‘˜ï¼ˆå¦‚ Gï¼‰">
<button onclick="addUser()">æ·»åŠ </button>

<p style="color:#666;font-size:12px;">
  âš ï¸ æ–°å¢äººå‘˜ä¼šç«‹åˆ»å‚ä¸æ’ç­å’Œç»Ÿè®¡
</p>

<hr>

<label>
  ä»Šæ—¥ä¼‘æ¯ï¼š
  <select id="restSelect"></select>
</label>

<h2>ğŸ•š 11 ç‚¹ï¼ˆæœ€å¤š 2 äººï¼‰</h2>
<div id="eat11"></div>
<div id="fullTip" class="full"></div>

<h2>ğŸ•› 12 ç‚¹</h2>
<div id="eat12"></div>

<h2>ğŸ“Š æœ¬æœˆ 11 ç‚¹ç»Ÿè®¡</h2>
<button onclick="exportCSV()">ğŸ“¤ å¯¼å‡º Excel</button>
<table id="statTable"></table>

<script>
/* ========= æ—¶é—´ & Key ========= */
const today = new Date().toISOString().slice(0,10);
const monthKey = today.slice(0,7);

const userKey = "lunch_users";
const stateKey = "lunch_" + today;
const statKey = "monthly_stats";
const snapKey = "snap_" + today;

/* ========= äººå‘˜ ========= */
let users = JSON.parse(localStorage.getItem(userKey)) || ["A","B","C","D","E","F"];

/* ========= ç™»å½• ========= */
let currentUser = localStorage.getItem("currentUser") || "";

/* ========= çŠ¶æ€ ========= */
let state = JSON.parse(localStorage.getItem(stateKey)) || {
  rest: users[users.length - 1],
  eat11: [],
  eat12: []
};

let monthlyStats = JSON.parse(localStorage.getItem(statKey)) || {};
monthlyStats[monthKey] ||= {};
users.forEach(u => monthlyStats[monthKey][u] ||= 0);

/* ========= å·¥å…· ========= */
function saveAll() {
  localStorage.setItem(userKey, JSON.stringify(users));
  localStorage.setItem(stateKey, JSON.stringify(state));
  localStorage.setItem(statKey, JSON.stringify(monthlyStats));
}

function after13() {
  return new Date().getHours() >= 13;
}

/* ========= 13:00 å¿«ç…§ ========= */
function snapshotIfNeeded() {
  if (!after13()) return;
  if (localStorage.getItem(snapKey)) return;

  state.eat11.forEach(u => {
    monthlyStats[monthKey][u]++;
  });

  localStorage.setItem(snapKey, "done");
  saveAll();
}

/* ========= ç™»å½• ========= */
function login() {
  currentUser = document.getElementById("userSelect").value;
  localStorage.setItem("currentUser", currentUser);
  init();
}

function logout() {
  localStorage.removeItem("currentUser");
  currentUser = "";
  init();
}

/* ========= æ–°å¢äººå‘˜ ========= */
function addUser() {
  const input = document.getElementById("newUserInput");
  const name = input.value.trim();
  if (!name || users.includes(name)) return;

  users.push(name);
  monthlyStats[monthKey][name] = 0;
  state.eat12.push(name);

  input.value = "";
  saveAll();
  init();
}

/* ========= ä¸šåŠ¡ ========= */
function choose11(u) {
  if (u !== currentUser) return;
  if (state.eat11.includes(u)) return;
  if (state.eat11.length >= 2) return;

  state.eat11.push(u);
  state.eat12 = state.eat12.filter(x => x !== u);
  saveAll();
  render();
}

/* ========= å¯¼å‡º CSV ========= */
function exportCSV() {
  let csv = "äººå‘˜,11ç‚¹æ¬¡æ•°\n";
  users.forEach(u => {
    csv += `${u},${monthlyStats[monthKey][u]}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `11ç‚¹ç»Ÿè®¡_${monthKey}.csv`;
  link.click();
}

/* ========= æ¸²æŸ“ ========= */
function render() {
  snapshotIfNeeded();

  document.getElementById("eat11").innerHTML =
    state.eat11.map(u => `<div>${u}</div>`).join("");

  document.getElementById("fullTip").innerText =
    state.eat11.length >= 2 ? "11 ç‚¹å·²æ»¡" : "";

  document.getElementById("eat12").innerHTML =
    state.eat12.map(u =>
      `<div>${u}
        ${u === currentUser ? `<button onclick="choose11('${u}')">æˆ‘è¦11ç‚¹</button>` : ""}
      </div>`
    ).join("");

  renderTable();
}

function renderTable() {
  let html = "<tr><th>äººå‘˜</th><th>æ¬¡æ•°</th></tr>";
  users.forEach(u => {
    html += `<tr><td>${u}</td><td>${monthlyStats[monthKey][u]}</td></tr>`;
  });
  document.getElementById("statTable").innerHTML = html;
}

/* ========= åˆå§‹åŒ– ========= */
function init() {
  const userSel = document.getElementById("userSelect");
  userSel.innerHTML = users.map(u => `<option>${u}</option>`).join("");

  if (!currentUser) {
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("currentUserBar").style.display = "none";
    render();
    return;
  }

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("currentUserBar").style.display = "block";
  document.getElementById("currentUserName").innerText = currentUser;

  const restSel = document.getElementById("restSelect");
  restSel.innerHTML = users.map(u =>
    `<option ${u===state.rest?"selected":""}>${u}</option>`
  ).join("");

  restSel.onchange = e => {
    state.rest = e.target.value;
    state.eat11 = [];
    state.eat12 = users.filter(u => u !== state.rest);
    saveAll();
    render();
  };

  if (!state.eat12.length) {
    state.eat12 = users.filter(u => u !== state.rest);
  }

  render();
}

init();
</script>

</body>
</html>
