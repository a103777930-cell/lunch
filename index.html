<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>åˆé¥­æ’ç­</title>
<style>
  body { font-family: Arial; padding: 20px; }
  h2 { margin-top: 25px; }
  .user { margin: 5px 0; }
  button { margin-left: 10px; }
  .admin { color: green; font-weight: bold; }
  table { border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #aaa; padding: 6px 10px; }
</style>
</head>

<body>

<h1>ğŸ± åˆé¥­æ’ç­</h1>

<!-- ç™»å½• -->
<div id="loginBox">
  ğŸ‘¤ æˆ‘æ˜¯ï¼š
  <select id="userSelect"></select>
  <button onclick="login()">ç¡®è®¤</button>
</div>

<div id="currentUserBar" style="display:none">
  å½“å‰ç”¨æˆ·ï¼š<span id="currentUserName"></span>
  <button onclick="logout()">åˆ‡æ¢ç”¨æˆ·</button>
</div>

<hr>

<!-- ç®¡ç†å‘˜é¢æ¿ -->
<div id="adminPanel" style="display:none">
  <h2 class="admin">ğŸ‘‘ ç®¡ç†å‘˜è®¾ç½®</h2>

  <div>
    11 ç‚¹æœ€å¤šäººæ•°ï¼š
    <select id="max11Select"></select>
  </div>

  <h3>äººå‘˜ç®¡ç†</h3>
  <input id="newUser" placeholder="æ–°å¢æˆå‘˜å">
  <button onclick="addUser()">æ–°å¢</button>

  <div id="userList"></div>

  <button onclick="exportExcel()">ğŸ“¤ å¯¼å‡º Excel</button>
  <hr>
</div>

<!-- ä»Šæ—¥ä¼‘æ¯ -->
<label>
  ä»Šæ—¥ä¼‘æ¯ï¼š
  <select id="restSelect"></select>
</label>

<h2>ğŸ•š 11 ç‚¹</h2>
<div id="eat11"></div>

<h2>ğŸ•› 12 ç‚¹</h2>
<div id="eat12"></div>

<h2>ğŸ“Š æœ¬æœˆ 11 ç‚¹ç»Ÿè®¡</h2>
<div id="statTable"></div>

<script>
/* ========= åŸºç¡€é…ç½® ========= */
let USERS = JSON.parse(localStorage.getItem("users")) || ["A","B","C","D","E","F"];
const ADMINS = ["A","B"];

let MAX_11 = Number(localStorage.getItem("MAX_11")) || 2;

const today = new Date().toISOString().slice(0,10);
const storeKey = "lunch_" + today;
const statKey = "lunch_stat";

/* ========= ç™»å½• ========= */
let currentUser = localStorage.getItem("currentUser") || "";

/* ========= æ•°æ® ========= */
let state = JSON.parse(localStorage.getItem(storeKey)) || {
  rest: "",
  eat11: [],
  eat12: []
};

let stats = JSON.parse(localStorage.getItem(statKey)) || {};
USERS.forEach(u => stats[u] ||= []);

/* ========= å·¥å…· ========= */
function isAdmin() {
  return ADMINS.includes(currentUser);
}

function save() {
  localStorage.setItem(storeKey, JSON.stringify(state));
  localStorage.setItem(statKey, JSON.stringify(stats));
  localStorage.setItem("users", JSON.stringify(USERS));
  localStorage.setItem("MAX_11", MAX_11);
}

/* ========= ç™»å½•é€»è¾‘ ========= */
function login() {
  currentUser = document.getElementById("userSelect").value;
  localStorage.setItem("currentUser", currentUser);
  init();
}

function logout() {
  localStorage.removeItem("currentUser");
  location.reload();
}

/* ========= äººå‘˜ç®¡ç† ========= */
function addUser() {
  const name = document.getElementById("newUser").value.trim();
  if (!name || USERS.includes(name)) return;
  USERS.push(name);
  stats[name] = [];
  save();
  init();
}

function removeUser(u) {
  USERS = USERS.filter(x => x !== u);
  delete stats[u];
  state.eat11 = state.eat11.filter(x => x !== u);
  state.eat12 = state.eat12.filter(x => x !== u);
  save();
  init();
}

/* ========= é€‰æ‹© 11 ç‚¹ ========= */
function choose11(user) {
  if (user !== currentUser) return;
  if (state.eat11.includes(user)) return;
  if (state.eat11.length >= MAX_11) return;

  state.eat11.push(user);
  state.eat12 = state.eat12.filter(u => u !== user);
  stats[user].push(today);
  save();
  render();
}

/* ========= Excel å¯¼å‡º ========= */
function exportExcel() {
  let csv = "æ—¥æœŸ,å§“å\n";
  Object.keys(stats).forEach(u => {
    stats[u].forEach(d => {
      csv += `${d},${u}\n`;
    });
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lunch_stat.csv";
  a.click();
}

/* ========= æ¸²æŸ“ ========= */
function render() {
  document.getElementById("currentUserName").innerText =
    currentUser + (isAdmin() ? "ï¼ˆç®¡ç†å‘˜ï¼‰" : "");

  document.getElementById("adminPanel").style.display =
    isAdmin() ? "block" : "none";

  const d11 = document.getElementById("eat11");
  const d12 = document.getElementById("eat12");
  d11.innerHTML = "";
  d12.innerHTML = "";

  state.eat11.forEach(u => d11.innerHTML += `<div>${u}</div>`);

  USERS.filter(u => u !== state.rest && !state.eat11.includes(u))
    .forEach(u => {
      d12.innerHTML += `
        <div>
          ${u}
          ${u === currentUser ? `<button onclick="choose11('${u}')">æˆ‘è¦ 11 ç‚¹</button>` : ""}
        </div>`;
    });

  renderStats();
}

/* ========= ç»Ÿè®¡è¡¨ ========= */
function renderStats() {
  let html = "<table><tr><th>å§“å</th><th>æ¬¡æ•°</th></tr>";
  USERS.forEach(u => {
    html += `<tr><td>${u}</td><td>${stats[u]?.length || 0}</td></tr>`;
  });
  html += "</table>";
  document.getElementById("statTable").innerHTML = html;
}

/* ========= åˆå§‹åŒ– ========= */
function init() {
  // ç™»å½•ä¸‹æ‹‰
  const sel = document.getElementById("userSelect");
  sel.innerHTML = "";
  USERS.forEach(u => sel.innerHTML += `<option>${u}</option>`);

  if (!currentUser) return;

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("currentUserBar").style.display = "block";

  // ä¼‘æ¯ä¸‹æ‹‰
  const restSel = document.getElementById("restSelect");
  restSel.innerHTML = `<option value="">æ— </option>`;
  USERS.forEach(u => restSel.innerHTML += `<option>${u}</option>`);
  restSel.value = state.rest;

  restSel.onchange = e => {
    state.rest = e.target.value;
    state.eat11 = [];
    state.eat12 = USERS.filter(u => u !== state.rest);
    save();
    render();
  };

  // ç®¡ç†å‘˜è®¾ç½®
  if (isAdmin()) {
    const maxSel = document.getElementById("max11Select");
    maxSel.innerHTML = "";
    for (let i = 1; i <= USERS.length; i++) {
      maxSel.innerHTML += `<option value="${i}">${i}</option>`;
    }
    maxSel.value = MAX_11;
    maxSel.onchange = e => {
      MAX_11 = Number(e.target.value);
      save();
      render();
    };

    const ul = document.getElementById("userList");
    ul.innerHTML = "";
    USERS.forEach(u => {
      ul.innerHTML += `
        <div>${u}
          ${!ADMINS.includes(u)
            ? `<button onclick="removeUser('${u}')">åˆ é™¤</button>`
            : "(ç®¡ç†å‘˜)"
          }
        </div>`;
    });
  }

  if (!state.eat12.length) {
    state.eat12 = USERS.filter(u => u !== state.rest);
  }

  render();
}

init();
</script>

</body>
</html>
