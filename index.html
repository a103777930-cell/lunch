<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>åˆé¥­æ’ç­</title>
<style>
  body { font-family: Arial; padding: 20px; }
  h2 { margin-top: 25px; }
  .user { margin: 5px 0; }
  button { margin-left: 10px; }
  .full { color: red; }
  .warn { color: orange; font-size: 12px; }
</style>
</head>

<body>

<h1>ğŸ± åˆé¥­æ’ç­</h1>

<!-- å½“å‰ç”¨æˆ· -->
<div id="currentUserBar" style="margin:10px 0; color:#555; display:none;">
  å½“å‰ç”¨æˆ·ï¼š<b id="currentUserName"></b>
  <button onclick="logout()">åˆ‡æ¢</button>
</div>

<!-- ç™»å½• -->
<div id="loginBox">
  ğŸ‘¤ æˆ‘æ˜¯ï¼š
  <select id="userSelect"></select>
  <button onclick="login()">ç¡®è®¤</button>
</div>

<hr>

<!-- ä»Šæ—¥ä¼‘æ¯ -->
<label>
  ä»Šæ—¥ä¼‘æ¯ï¼š
  <select id="restSelect"></select>
</label>

<h2>ğŸ•š 11 ç‚¹ï¼ˆæœ€å¤š 2 äººï¼‰</h2>
<div id="eat11"></div>
<div id="fullTip" class="full"></div>

<h2>ğŸ•› 12 ç‚¹</h2>
<div id="eat12"></div>

<script>
/* ========== åŸºç¡€é…ç½® ========== */
const users = ["A","B","C","D","E","F"];
const MAX_11 = 2;
const FAIR_LIMIT = 3;

const today = new Date().toISOString().slice(0,10);
const storeKey = "lunch_" + today;
const statKey = "lunch_stat";

/* ========== ç™»å½•çŠ¶æ€ ========== */
let currentUser = localStorage.getItem("currentUser") || "";

/* ========== æ•°æ® ========== */
let state = JSON.parse(localStorage.getItem(storeKey)) || {
  rest: "F",
  eat11: [],
  eat12: []
};

let stats = JSON.parse(localStorage.getItem(statKey)) || {};
users.forEach(u => stats[u] ||= []);

/* ========== å·¥å…·å‡½æ•° ========== */
function save() {
  localStorage.setItem(storeKey, JSON.stringify(state));
  localStorage.setItem(statKey, JSON.stringify(stats));
}

function offsetDay(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0,10);
}

function recent11Count(user) {
  return (stats[user] || []).filter(d => d >= offsetDay(-5)).length;
}

/* ========== ç™»å½• / åˆ‡æ¢ ========== */
function login() {
  const sel = document.getElementById("userSelect");
  currentUser = sel.value;
  localStorage.setItem("currentUser", currentUser);

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("currentUserName").innerText = currentUser;
  document.getElementById("currentUserBar").style.display = "block";

  init();
}

function logout() {
  localStorage.removeItem("currentUser");
  currentUser = "";
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("currentUserBar").style.display = "none";
  init();
}

/* ========== ä¸šåŠ¡é€»è¾‘ ========== */
function choose11(user) {
  if (user !== currentUser) return;
  if (state.eat11.includes(user)) return;
  if (state.eat11.length >= MAX_11) return;

  if (recent11Count(user) >= FAIR_LIMIT) {
    alert(user + " æœ€è¿‘ 11 ç‚¹æ¬¡æ•°å¤ªå¤šäº† ğŸ˜…");
    return;
  }

  state.eat11.push(user);
  state.eat12 = state.eat12.filter(u => u !== user);
  stats[user].push(today);

  save();
  render();
}

/* ========== æ¸²æŸ“ ========== */
function render() {
  const d11 = document.getElementById("eat11");
  const d12 = document.getElementById("eat12");
  const tip = document.getElementById("fullTip");

  d11.innerHTML = "";
  d12.innerHTML = "";
  tip.innerHTML = "";

  state.eat11.forEach(u => {
    d11.innerHTML += `<div class="user">${u}</div>`;
  });

  if (state.eat11.length >= MAX_11) {
    tip.innerText = "11 ç‚¹å·²æ»¡";
  }

  state.eat12.forEach(u => {
    const warn = recent11Count(u) >= FAIR_LIMIT
      ? `<span class="warn">ï¼ˆæœ€è¿‘ 11 ç‚¹åå¤šï¼‰</span>` : "";

    d12.innerHTML += `
      <div class="user">
        ${u} ${warn}
        ${
          u === currentUser
            ? `<button onclick="choose11('${u}')">æˆ‘è¦ 11 ç‚¹</button>`
            : `<span class="warn">ï¼ˆä¸æ˜¯ä½ ï¼‰</span>`
        }
      </div>
    `;
  });
}

/* ========== åˆå§‹åŒ– ========== */
function init() {
  // ç™»å½•ä¸‹æ‹‰
  const userSel = document.getElementById("userSelect");
  userSel.innerHTML = "";
  users.forEach(u => {
    const o = document.createElement("option");
    o.value = u;
    o.text = u;
    userSel.appendChild(o);
  });

  // å½“å‰ç”¨æˆ·æ˜¾ç¤º
  if (currentUser) {
    document.getElementById("currentUserName").innerText = currentUser;
    document.getElementById("currentUserBar").style.display = "block";
    document.getElementById("loginBox").style.display = "none";
  } else {
    document.getElementById("currentUserBar").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
    render();
    return;
  }

  // ä»Šæ—¥ä¼‘æ¯
  const restSel = document.getElementById("restSelect");
  restSel.innerHTML = "";
  users.forEach(u => {
    const o = document.createElement("option");
    o.value = u;
    o.text = u;
    if (u === state.rest) o.selected = true;
    restSel.appendChild(o);
  });

  restSel.onchange = e => {
    state.rest = e.target.value;
    state.eat11 = [];
    state.eat12 = users.filter(u => u !== state.rest);
    save();
    render();
  };

  if (!state.eat12.length) {
    state.eat12 = users.filter(u => u !== state.rest);
  }

  render();
}

init();
</script>

</body>
</html>
