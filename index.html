<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>åˆé¥­æ’ç­</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f4f4f9;
    color: #333;
  }
  h1 { text-align: center; margin-bottom: 20px; }
  h2 { margin: 0; }
  .container {
    display: flex;
    gap: 20px;
  }
  .main {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 20px;
    transition: flex 0.3s;
  }
  .main.compact { flex: 1; }
  .card {
    background: #fff;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .sidebar {
    flex: 1;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-height: 80vh;
    overflow-y: auto;
  }
  label { display: block; margin: 2px 0; }
  button { margin-left: 5px; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 12px; }
  button:hover { background-color: #eee; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 14px; }
  th, td { border: 1px solid #aaa; padding: 6px 10px; text-align: center; }
  #currentUserBar { margin-bottom: 20px; text-align: center; }
  .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .user-grid { display: flex; flex-wrap: wrap; gap: 5px; }
  .user-grid .user-item { flex: 0 0 calc(33.33% - 5px); display: flex; align-items: center; font-size: 14px; }
</style>
</head>

<body>

<h1>ğŸ± åˆé¥­æ’ç­</h1>

<!-- ç™»å½• -->
<div id="loginBox" style="text-align:center; margin-bottom:20px;">
  ğŸ‘¤ æˆ‘æ˜¯ï¼š
  <select id="userSelect"></select>
  <input type="checkbox" id="rememberMe"> è®°ä½æˆ‘
  <button onclick="login()">ç¡®è®¤</button>
</div>

<div id="currentUserBar" style="display:none;">
  å½“å‰ç”¨æˆ·ï¼š<span id="currentUserName"></span>
  <button onclick="logout()">åˆ‡æ¢ç”¨æˆ·</button>
</div>

<div class="container">
  <!-- ä¸»åŒº -->
  <div class="main" id="mainArea">
    <!-- ä»Šæ—¥ä¼‘æ¯ -->
    <div class="card">
      <div class="section-title">
        <h2>ğŸ˜´ ä»Šæ—¥ä¼‘æ¯</h2>
        <span id="restCount"></span>
      </div>
      <div>
        11 ç‚¹æœ€å¤šä¼‘æ¯äººæ•°ï¼š
        <select id="maxRestSelect"></select>
      </div>
      <div id="restBox" class="user-grid" style="margin-top:10px;"></div>
    </div>

    <!-- 11ç‚¹ -->
    <div class="card">
      <div class="section-title">
        <h2>ğŸ•š 11 ç‚¹</h2>
        <span id="eat11Count"></span>
      </div>
      <div id="eat11" class="user-grid"></div>
    </div>

    <!-- 12ç‚¹ -->
    <div class="card">
      <div class="section-title">
        <h2>ğŸ•› 12 ç‚¹</h2>
      </div>
      <div id="eat12" class="user-grid"></div>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="card">
      <h2>ğŸ“Š æœ¬æœˆ 11 ç‚¹ç»Ÿè®¡</h2>
      <div id="statTable"></div>
    </div>
  </div>

  <!-- ç®¡ç†å‘˜é¢æ¿ -->
  <div class="sidebar" id="adminPanel" style="display:none;">
    <h2 class="admin">ğŸ‘‘ ç®¡ç†å‘˜è®¾ç½®</h2>
    <h3>äººå‘˜ç®¡ç†</h3>
    <input id="newUser" placeholder="æ–°å¢æˆå‘˜å">
    <label><input type="checkbox" id="newAdmin"> ç®¡ç†å‘˜</label>
    <button onclick="addUser()">æ–°å¢</button>
    <div id="userList" style="margin-top:10px;"></div>
    <button style="margin-top:10px;" onclick="exportExcel()">ğŸ“¤ å¯¼å‡º Excel</button>
  </div>
</div>

<script>
let USERS = JSON.parse(localStorage.getItem("users")) || ["A","B","C","D","E","F"];
let ADMINS = JSON.parse(localStorage.getItem("admins")) || ["A","B"];
let MAX_11 = Number(localStorage.getItem("MAX_11")) || 2;
let MAX_REST = Number(localStorage.getItem("MAX_REST")) || USERS.length;

const today = new Date().toISOString().slice(0,10);
const storeKey = "lunch_" + today;
const statKey = "lunch_stat";

let currentUser = localStorage.getItem("currentUser") || sessionStorage.getItem("currentUser") || "";

let state = JSON.parse(localStorage.getItem(storeKey)) || {rest: [], eat11: [], eat12: []};
let stats = JSON.parse(localStorage.getItem(statKey)) || {};
USERS.forEach(u => stats[u] = stats[u] || []);

function isAdmin() { return ADMINS.includes(currentUser); }
function save() {
  localStorage.setItem(storeKey, JSON.stringify(state));
  localStorage.setItem(statKey, JSON.stringify(stats));
  localStorage.setItem("users", JSON.stringify(USERS));
  localStorage.setItem("admins", JSON.stringify(ADMINS));
  localStorage.setItem("MAX_11", MAX_11);
  localStorage.setItem("MAX_REST", MAX_REST);
}

function login() {
  currentUser = document.getElementById("userSelect").value;
  const remember = document.getElementById("rememberMe").checked;
  if (remember) localStorage.setItem("currentUser", currentUser);
  else sessionStorage.setItem("currentUser", currentUser);
  init();
}

function logout() { localStorage.removeItem("currentUser"); sessionStorage.removeItem("currentUser"); location.reload(); }

function addUser() {
  const name = document.getElementById("newUser").value.trim();
  if (!name || USERS.includes(name)) return;
  USERS.push(name);
  stats[name] = [];
  if(document.getElementById("newAdmin").checked) ADMINS.push(name);
  save();
  init();
}

function removeUser(u) {
  if (!confirm(`ç¡®å®šåˆ é™¤ç”¨æˆ· ${u} åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) return;
  USERS = USERS.filter(x => x!==u);
  stats[u] && delete stats[u];
  state.rest = state.rest.filter(x=>x!==u);
  state.eat11 = state.eat11.filter(x=>x!==u);
  state.eat12 = state.eat12.filter(x=>x!==u);
  ADMINS = ADMINS.filter(x=>x!==u);
  save();
  init();
}

function toggleRest(user, checked) {
  if(checked){
    if(state.rest.length>=MAX_REST){ alert(`ä¼‘æ¯äººæ•°å·²è¾¾ä¸Šé™ (${MAX_REST})`); render(); return; }
    if(!state.rest.includes(user)) state.rest.push(user);
    state.eat11 = state.eat11.filter(u=>u!==user);
  } else state.rest = state.rest.filter(u=>u!==user);
  save(); render();
}

function choose11(user) {
  if(user!==currentUser) return;
  if(state.eat11.includes(user)){ alert("ä½ å·²é€‰æ‹© 11 ç‚¹ï¼"); return; }
  if(state.eat11.length>=MAX_11){ alert("11 ç‚¹äººæ•°å·²æ»¡ï¼"); return; }
  if(state.rest.includes(user)){ alert("ä½ ä»Šå¤©å·²ä¼‘æ¯ï¼Œæ— æ³•é€‰æ‹© 11 ç‚¹"); return; }
  state.eat11.push(user);
  stats[user].push(today);
  save(); render();
}

function exportExcel() {
  let csv = `"æ—¥æœŸ","å§“å"\n`;
  Object.keys(stats).forEach(u=>stats[u].forEach(d=>{csv+=`"${d}","${u}"\n`;}));
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lunch_stat.csv";
  a.click();
}

function render(){
  document.getElementById("currentUserName").innerText = currentUser + (isAdmin()?"ï¼ˆç®¡ç†å‘˜ï¼‰":"");
  document.getElementById("mainArea").classList.toggle("compact", !isAdmin());
  document.getElementById("adminPanel").style.display = isAdmin()?"block":"none";

  // ä¼‘æ¯äººæ•°ä¸Šé™
  const maxRestSel = document.getElementById("maxRestSelect");
  maxRestSel.innerHTML="";
  for(let i=1;i<=USERS.length;i++) maxRestSel.innerHTML+=`<option value="${i}">${i}</option>`;
  maxRestSel.value = MAX_REST;
  maxRestSel.onchange = e=>{ MAX_REST=Number(e.target.value); save(); render(); };

  // ä»Šæ—¥ä¼‘æ¯
  const restBox = document.getElementById("restBox");
  restBox.innerHTML="";
  USERS.forEach(u=>{
    restBox.innerHTML+=`<div class="user-item"><label><input type="checkbox" ${state.rest.includes(u)?"checked":""} onchange="toggleRest('${u}',this.checked)">${u}</label></div>`;
  });
  document.getElementById("restCount").innerText = `${state.rest.length}/${MAX_REST}`;

  // 11ç‚¹
  const d11 = document.getElementById("eat11");
  const d12 = document.getElementById("eat12");
  d11.innerHTML="";
  d12.innerHTML="";
  state.eat11.forEach(u=>d11.innerHTML+=`<div class="user-item">${u}</div>`);
  USERS.filter(u=>!state.rest.includes(u)&&!state.eat11.includes(u))
       .forEach(u=>d12.innerHTML+=`<div class="user-item">${u}${u===currentUser?`<button onclick="choose11('${u}')">æˆ‘è¦ 11 ç‚¹</button>`:""}</div>`);
  document.getElementById("eat11Count").innerText = `${state.eat11.length}/${MAX_11}`;

  // ç»Ÿè®¡
  renderStats();

  // ç®¡ç†å‘˜åˆ—è¡¨
  if(isAdmin()){
    const ul = document.getElementById("userList");
    ul.innerHTML="";
    USERS.forEach(u=>ul.innerHTML+=`<div>${u} ${ADMINS.includes(u)?"(ç®¡ç†å‘˜)":"<button onclick='removeUser(\""+u+"\")'>åˆ é™¤</button>"} </div>`);
  }
}

function renderStats(){
  let html="<table><tr><th>å§“å</th><th>11 ç‚¹æ¬¡æ•°</th></tr>";
  USERS.forEach(u=>html+=`<tr><td>${u}</td><td>${stats[u]?.length||0}</td></tr>`);
  html+="</table>";
  document.getElementById("statTable").innerHTML=html;
}

function init(){
  const sel=document.getElementById("userSelect");
  sel.innerHTML="";
  USERS.forEach(u=>sel.innerHTML+=`<option>${u}</option>`);
  if(!currentUser) return;
  document.getElementById("loginBox").style.display="none";
  document.getElementById("currentUserBar").style.display="block";
  render();
}

init();
</script>
</body>
</html>
